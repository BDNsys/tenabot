<!-- tenabot/bot/templates/bot/bot.html -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TenaBot ‚Äî Your Resume Assistant</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    /* Define fallback CSS variables for Telegram Theme */
    :root {
      --tg-theme-bg-color: #1c1c1c;
      --tg-theme-text-color: #fff;
      --tg-theme-button-color: #5E62F4;
      --tg-theme-button-text-color: #fff;
      --tg-theme-secondary-bg-color: #2b2b2b;
      --tg-theme-hint-color: #a0a0a0;
      --tg-theme-link-color: #5E62F4;
      --tg-theme-destructive-text-color: #ff3b30;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--tg-theme-bg-color);
      color: var(--tg-theme-text-color);
      transition: background-color 0.3s, color 0.3s;
    }

    .btn {
      background-color: var(--tg-theme-button-color);
      color: var(--tg-theme-button-text-color);
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.2s;
      width: 100%;
    }

    .btn:hover:not(:disabled) {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .btn:disabled {
      background-color: var(--tg-theme-hint-color);
      cursor: not-allowed;
    }

    .card {
      background-color: var(--tg-theme-secondary-bg-color);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .input-field {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid var(--tg-theme-secondary-bg-color);
      background-color: var(--tg-theme-bg-color);
      color: var(--tg-theme-text-color);
      margin-bottom: 1rem;
    }

    textarea.input-field {
      resize: vertical;
      min-height: 100px;
    }

    .error-message {
      color: var(--tg-theme-destructive-text-color);
      font-size: 0.875rem;
      margin-top: -0.5rem;
      margin-bottom: 1rem;
    }

    .hidden-view {
      display: none;
    }

    /* Progress Bar Styles */
    .progress-bar {
      height: 12px;
      border-radius: 6px;
      background-color: var(--tg-theme-bg-color);
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background-color: var(--tg-theme-button-color);
      transition: width 0.5s ease-in-out;
    }
  </style>
</head>

<body class="h-screen flex items-center justify-center">

  <div class="max-w-md w-full p-6">

    <div id="welcome-view" class="card">
      <h1 class="text-2xl font-bold mb-2">üëã Welcome to TenaBot</h1>
      <p class="text-gray-400 text-sm mb-6">Your AI-powered resume companion inside Telegram.</p>

      <div class="mb-4">
        <p class="text-gray-300">
          <span class="font-semibold">User:</span>
          <span id="user-name">Loading...</span>
        </p>
        <p class="text-gray-300">
          <span class="font-semibold">Telegram ID:</span>
          <span id="user-id">...</span>
        </p>
      </div>

      <button id="goToUploadBtn" class="btn">üìÑ Upload Resume</button>
    </div>

    <div id="upload-view" class="card hidden-view">
      <h2 class="text-xl font-bold mb-4">üì§ Upload Your Resume</h2>
      <p class="text-gray-400 text-sm mb-4">PDF files only. Max size: 7MB.</p>

      <form id="uploadForm">
        <label for="job_title" class="block text-sm font-medium mb-1">Target Job Title <span
            class="text-red-500">*</span></label>
        <input type="text" id="job_title" name="job_title" class="input-field"
          placeholder="e.g., Senior Software Engineer" required>

        <label for="job_description" class="block text-sm font-medium mb-1 mt-4">Job Description (Optional)</label>
        <textarea id="job_description" name="job_description" class="input-field"
          placeholder="Paste the job description here for better tailoring."></textarea>

        <label for="pdf_file" class="block text-sm font-medium mb-1 mt-4">Select PDF Resume <span
            class="text-red-500">*</span></label>
        <input type="file" id="pdf_file" name="pdf_file" accept=".pdf" class="input-field pt-2" required>

        <p id="upload-error" class="error-message hidden-view"></p>

        <button type="submit" id="submitUploadBtn" class="btn mt-4">‚¨ÜÔ∏è Start Analysis</button>
        <button type="button" id="cancelUploadBtn" class="btn mt-2 !bg-gray-500 hover:!bg-gray-600">Cancel</button>
      </form>
    </div>

    <div id="loading-view" class="card hidden-view text-center">
      <div class="text-5xl mb-4 animate-pulse">ü§ñ</div>
      <h2 class="text-xl font-bold mb-2">Analyzing Your Resume...</h2>
      <p id="loading-message" class="text-gray-400 text-sm mb-6 h-10 flex items-center justify-center">
        Starting analysis...
      </p>

      <div class="progress-bar mb-6">
        <div id="progress-fill" class="progress-fill"></div>
      </div>

      <p class="text-sm text-gray-500">Please keep the Web App open.</p>
    </div>

    <div id="success-view" class="card hidden-view text-center">
      <div class="text-5xl mb-4">üéâ</div>
      <h2 class="text-2xl font-bold mb-2">Analysis Complete!</h2>
      <p class="text-gray-400 mb-6">Your new Harvard-style resume is being sent to your Telegram chat.</p>
      <p id="success-details" class="text-sm text-gray-300 mb-6"></p>

      <button id="closeWebAppBtn" class="btn mt-4">Close Web App</button>
    </div>

  </div>
  <script>
    // === CONFIGURATION ===
    const API_REGISTER_URL = "https://tena.bdnsys.com/api/register_telegram_user/";
    const API_UPLOAD_URL = "https://tena.bdnsys.com/bot/upload-resume/";

    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    tg.setHeaderColor("secondary_bg_color");
    tg.setBackgroundColor("bg_color");

    // === STATE ===
    let accessToken = sessionStorage.getItem("accessToken") || null;
    let refreshToken = sessionStorage.getItem("refreshToken") || null;
    let loadingInterval = null;
    let progressInterval = null;

    const views = {
      'welcome': document.getElementById('welcome-view'),
      'upload': document.getElementById('upload-view'),
      'loading': document.getElementById('loading-view'),
      'success': document.getElementById('success-view'),
    };

    const LOADING_MESSAGES = [
      "Securing connection and initializing AI parsing engines...",
      "Extracting core skills and work history...",
      "Identifying critical job keywords...",
      "Crafting Harvard-style resume bullets...",
      "Optimizing layout and formatting...",
      "Preparing PDF...",
      "Sending results to Telegram...",
    ];

    // === VIEW HANDLING ===
    function switchView(viewId, details = null) {
      clearInterval(loadingInterval);
      clearInterval(progressInterval);
      Object.keys(views).forEach(v => views[v].classList.toggle("hidden-view", v !== viewId));

      if (viewId === "success" && details) {
        document.getElementById('success-details').innerHTML = `
        <p><strong>Resume ID:</strong> ${details.resume_id}</p>
        <p><strong>Job Title:</strong> ${details.job_title}</p>
        <p><strong>Uploads Today:</strong> ${details.uploads_today}</p>
      `;
      } else if (viewId === "loading") startLoadingEffect();
    }

    function startLoadingEffect() {
      let i = 0, progress = 5;
      const msg = document.getElementById("loading-message");
      const bar = document.getElementById("progress-fill");

      loadingInterval = setInterval(() => {
        msg.textContent = LOADING_MESSAGES[i++ % LOADING_MESSAGES.length];
      }, 3000);

      progressInterval = setInterval(() => {
        if (progress < 90) {
          progress += 5;
          bar.style.width = `${progress}%`;
        } else clearInterval(progressInterval);
      }, 500);
    }

    function finishLoadingEffect() {
      clearInterval(loadingInterval);
      clearInterval(progressInterval);
      document.getElementById("progress-fill").style.width = "100%";
      document.getElementById("loading-message").textContent = "Finalizing...";
    }

    // === AUTH ===
    async function registerUser(userData) {
      const initData = tg?.initData;
      if (!initData) return tg.showAlert("Telegram initData missing.");

      try {
        const res = await fetch(API_REGISTER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ initData })
        });

        const data = await res.json();
        if (!res.ok || !data.access) {
          tg.showAlert("Authentication failed. Restart bot.");
          return;
        }

        accessToken = data.access;
        refreshToken = data.refresh;

        sessionStorage.setItem("accessToken", accessToken);
        sessionStorage.setItem("refreshToken", refreshToken);

        updateUI(data.user);
      } catch (e) {
        tg.showAlert("Network error during login");
      }
    }

    // === UI ===
    function updateUI(user) {
      document.getElementById("user-name").textContent =
        `${user.first_name} ${user.last_name} (@${user.username})`;
      document.getElementById("user-id").textContent = user.telegram_id;
    }

    // === FILE UPLOAD ===
    async function handleFileUpload(e) {
      e.preventDefault();
      const file = document.getElementById('pdf_file').files[0];
      const job = document.getElementById('job_title').value;
      const desc = document.getElementById('job_description').value;

      if (!file) return showError("Please select a PDF");

      switchView("loading");
      tg.MainButton.show().setText("AI working...");

      const formData = new FormData();
      formData.append("pdf_file", file);
      formData.append("job_title", job);
      formData.append("job_description", desc);

      try {
        const res = await fetch(API_UPLOAD_URL, {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${accessToken}`
          },
          body: formData
        });

        const data = await res.json();
        finishLoadingEffect();

        if (res.ok) {
          setTimeout(() => {
            switchView("success", {
              resume_id: data.resume_id,
              job_title: job,
              uploads_today: data.uploads_today
            });
            tg.MainButton.hide();
          }, 500);
        } else showError(data.detail || "Upload failed");
      } catch {
        showError("Upload failed. Check network.");
        switchView("upload");
      }
    }

    function showError(msg) {
      const err = document.getElementById("upload-error");
      err.textContent = msg;
      err.classList.remove("hidden-view");
      tg.showAlert(msg);
    }

    // === INIT ===
    document.addEventListener("DOMContentLoaded", () => {
      const u = tg?.initDataUnsafe?.user;
      if (u) {
        updateUI(u);
        registerUser(u);
      }

      document.getElementById("goToUploadBtn").onclick = () => switchView("upload");
      document.getElementById("cancelUploadBtn").onclick = () => switchView("welcome");
      document.getElementById("uploadForm").onsubmit = handleFileUpload;
      document.getElementById("closeWebAppBtn").onclick = () => tg.close();
    });
  </script>

</body>

</html>